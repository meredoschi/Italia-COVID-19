---
title: "Calculations and charts - Italian provinces (by region) - COVID-19 Epidemic"
author: "Marcelo Eduardo Redoschi"
output: html_document
---

#### Based on the Protezione Civile Dataset and adjusted for the ISTAT (National Statistics Institute) regional and provincial nomenclature

*Source: dpc-covid19-ita-province.csv, own calculations*

```{r echo=FALSE, message=FALSE}
# Initial setup (Libraries and paths)
library(readr)
library(lubridate)
library(dplyr)
library(markdown)
library(ggplot2)
source(file.path(getwd(),"helper_functions.R"))
datasets_path<-file.path(getwd(),"..", "Protezione-Civile-Dataset","COVID-19") 
csv_exports_dir<-file.path(getwd(),"..", "csv_exports") 
```


```{r echo=FALSE, message=FALSE}
# ISTAT (National Statistics Institute) regional and provincial classification
ISTAT_path<-file.path(getwd(),"..", "ISTAT-CSV-Data") 
istat_pop_file_name<-file.path(ISTAT_path,"DCIS_POPRES1_11042020115451140.csv")
istat_area_file_name<-file.path(ISTAT_path,"DCCV_CARGEOMOR_ST_COM_12042020123304098.csv")

istat_population<-process_population_csv(istat_pop_file_name)
istat_country<-retrieve_istat_country(istat_population)
istat_zones<-retrieve_istat_zones(istat_population)
istat_regions<-retrieve_istat_regions(istat_population)
istat_provinces<-retrieve_istat_provinces(istat_population) 
istat_provinces$regional_territory_code<-substring(istat_provinces$territory_code,1,4)
istat_provinces<-provinces_regional_territory_code_fix(istat_provinces)

istat_area<-import_csv(istat_area_file_name)
istat_area<-istat_area[istat_area$`Data.type`=="total area (km2)",]
#istat_area<-select(istat_area, ITTER107, Territory, Value)
istat_area<-select(istat_area, Territory, Value)
col_names<-colnames(istat_area)
#col_names<-gsub("ITTER107","territory_code",col_names)
col_names<-gsub("Territory","territory_name",col_names)
col_names<-gsub("Value","km2",col_names)
colnames(istat_area)<-col_names
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Provincial data - CSV Import from local subdirectory

provincial_data_csv_fname<-file.path(datasets_path,"dati-province","dpc-covid19-ita-province.csv")
dpc_covid19_ita_provinces<-import_csv(provincial_data_csv_fname)

provinces_data<-filter_extraneous_rows(dpc_covid19_ita_provinces)
provinces_data<-trentino_sudtirol_fix(provinces_data,"Trentino Alto Adige / Südtirol")
provinces_data<-fix_region_names(istat_regions, provinces_data)
provinces_data<-dpc_to_istat_province_name_fix(provinces_data,istat_provinces)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
provinces_regions_key <-
  inner_join(istat_provinces,
  provinces_data,
  by = c('province_name' = 'denominazione_provincia'))
  
  provinces_regions_key <-
  distinct(
  select(
  provinces_regions_key,
  province_name,
  sigla_provincia,
  codice_provincia,
  territory_code,
  denominazione_regione,
  codice_regione,
  regional_territory_code
  )
  )
  italian_regions <-
  distinct(select(provinces_regions_key, denominazione_regione))
  italian_regions <- arrange(italian_regions, denominazione_regione)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
provinces_data <-
  inner_join(provinces_data,
             istat_provinces,
             by = c('denominazione_provincia' = 'province_name'))
             provinces_data <- add_dt_column(provinces_data)
```


```{r echo=FALSE, message=FALSE}
# Adds total case columns for the respective dates (generalized version)
provinces_data <-
  expand_dt_columns(provinces_data, "denominazione_provincia", "totale_casi") 
```

```{r echo=FALSE, message=FALSE}
provinces_calculations <- provinces_data

current_total_cases <-
total_cases_on_dt(provinces_data, days_before(provinces_data, 0))
total_cases_1_day_before <-
total_cases_on_dt(provinces_data, days_before(provinces_data, 1))
total_cases_2_days_before <-
total_cases_on_dt(provinces_data, days_before(provinces_data, 2))
total_cases_3_days_before <-
total_cases_on_dt(provinces_data, days_before(provinces_data, 3))
total_cases_4_days_before <-
total_cases_on_dt(provinces_data, days_before(provinces_data, 4))

provinces_calculations$current_rate <-
current_total_cases / total_cases_1_day_before
provinces_calculations$yesterdays_rate <-
total_cases_1_day_before / total_cases_2_days_before
provinces_calculations$rate_two_days_before <-
total_cases_2_days_before / total_cases_3_days_before
provinces_calculations$rate_three_days_before <-
total_cases_3_days_before / total_cases_4_days_before

provinces_calculations$cubic_rate <-
'^'(current_total_cases / total_cases_3_days_before,1/3)
provinces_calculations$cubic_perc_rate <-
(provinces_calculations$cubic_rate - 1) * 100
provinces_calculations$current_perc_rate <-
(provinces_calculations$current_rate - 1) * 100
provinces_calculations$trend <-
(provinces_calculations$current_rate - provinces_calculations$cubic_rate)*100
provinces_calculations$per_capita_rate <-
provinces_calculations$totale_casi / provinces_calculations$population *
1000

most_recent_dt <- retrieve_most_recent_dt(provinces_calculations)
three_days_before <- most_recent_dt - 3
provinces_latest <-
provinces_calculations[provinces_calculations$dt == most_recent_dt, ]

# Increasing rate in total cases
prov_increasing_trend <- provinces_latest[provinces_latest$trend > 0, ]
prov_increasing_trend <-
select(
prov_increasing_trend,
denominazione_provincia,
totale_casi,
current_perc_rate,
trend,
per_capita_rate
)
prov_increasing_trend <- arrange(prov_increasing_trend,-trend)
```

### Provinces with an augmenting rate of increase in the number of cases
```{r echo=FALSE, message=FALSE}
print(retrieve_most_recent_dt(provinces_latest),row.names = F)
print(rounded_province_trends(prov_increasing_trend,2))

```

### Provinces with a steady or declining rate of increase 
```{r echo=FALSE, message=FALSE} 
print(retrieve_most_recent_dt(provinces_latest),row.names = F)
prov_declining_trend <- provinces_latest[provinces_latest$trend <= 0, ]
prov_declining_trend <-
select(
prov_declining_trend,
denominazione_provincia,
totale_casi,
current_perc_rate,
trend,
per_capita_rate
)
prov_declining_trend <- arrange(prov_declining_trend,-trend)
#print(prov_declining_trend)
print(rounded_province_trends(prov_declining_trend,2))
```
*Trend is an approximation = (current_rate-cubic_rate)x100*


```{r echo=FALSE, message=FALSE} 
### Total cases per area (km2)
```

### Provinces per capita (expressed as per thousand people)  ‰ rate.
```{r echo=FALSE, message=FALSE} 
provinces_per_capita <-
  select(
  provinces_calculations,
  dt,
  denominazione_provincia,
#  denominazione_regione,
  totale_casi,
  per_capita_rate
  )
  most_recent_dt <- max(provinces_per_capita$dt)
  provinces_per_capita <- arrange(provinces_per_capita, -per_capita_rate)
  #print(most_recent_dt)
  
  provinces_per_capita_latest <-
  provinces_per_capita[provinces_per_capita$dt == most_recent_dt, ]
  provinces_per_capita_latest$pos <-
  nrow(provinces_per_capita_latest) - rank(provinces_per_capita_latest$per_capita_rate) +
  1
  prov_per_capita_latest_sel <-
  arrange(provinces_per_capita_latest,-per_capita_rate)
  provinces_per_capita_latest_sel<-select(
  provinces_per_capita_latest,
  pos,
  denominazione_provincia,
#  denominazione_regione,
  per_capita_rate
  )
  
  prov_per_capita_latest_sel$per_capita_rate<-round(prov_per_capita_latest_sel$per_capita_rate, digits=2)
  
  prov_per_capita_latest_sel$dt<-NULL 
  
  print(prov_per_capita_latest_sel, row.names = F)
  print(summary(provinces_per_capita_latest$per_capita_rate))
  rm(prov_per_capita_latest_sel)
```

```{r echo=FALSE, message=FALSE} 
write.csv(provinces_calculations,file.path(csv_exports_dir,"provinces_calculations.csv"))
write.csv(provinces_latest,file.path(csv_exports_dir,"provinces_latest.csv"))
write.csv(prov_increasing_trend,file.path(csv_exports_dir,"provinces_increasing_trend.csv"))
write.csv(prov_declining_trend,file.path(csv_exports_dir,"provinces_declining_trend.csv"))
write.csv(provinces_regions_key,file.path(csv_exports_dir,"provinces_regions_key.csv"))
write.csv(provinces_per_capita,file.path(csv_exports_dir,"provinces_per_capita.csv"))
write.csv(provinces_per_capita_latest,file.path(csv_exports_dir,"provinces_per_capita_latest.csv"))
```

### Graphs - Total case progression - Provinces by region (for the most recent days observed)

```{r echo=FALSE, message=FALSE}
require(ggplot2)

specified_cols <-
c(
"dt",
"denominazione_provincia",
"denominazione_regione",
"totale_casi",
"current_perc_rate",
"cubic_perc_rate",
"per_capita_rate"
)



prov_calc_sel <-
select(provinces_calculations, all_of(specified_cols))

prov_calc_sel <- filtered_for_the_most_recent_days(prov_calc_sel, 1)

prov_calc_sel <- translated_province_column_names(prov_calc_sel)
for (i in 1:nrow(italian_regions)) {
selected_region <- italian_regions[i, ]
print(plot_cubic_rate_chart(provinces_calculations, selected_region))
local_provinces <-
filtered_by_region(prov_calc_sel, selected_region)

local_provinces$denominazione_regione <- NULL
local_provinces$percent_rate <-
round(local_provinces$current_perc_rate, digits = 2)
local_provinces$three_day_rate <-
round(local_provinces$cubic_perc_rate, digits = 2)
local_provinces$current_perc_rate <- NULL
local_provinces$cubic_perc_rate <- NULL

observation_dt <- mean(local_provinces$dt)
print(observation_dt, row.names = F)
local_provinces$dt <- NULL
print(local_provinces, row.names = F)

}

rm(local_provinces)    
          
```

*This page last updated: 19/4/2020*
