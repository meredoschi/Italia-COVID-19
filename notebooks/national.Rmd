---
title: "National data - work in progress (DRAFT)"
author: "Marcelo Eduardo Redoschi"
output: html_document
---

### Libraries and paths 

```{r}
library(readr)
library(lubridate)
library(dplyr)
library(markdown)
source("helper_functions.R")
datasets_path<-file.path(getwd(),"..", "COVID-19") 
```

## 2. National data - CSV Import step

*dpc-covid19-ita-andamento-nazionale.csv*
```{r}
national_csv_fname<-file.path(datasets_path,"dati-andamento-nazionale","dpc-covid19-ita-andamento-nazionale.csv")
national<-read.csv(national_csv_fname,encoding="UTF-8", na.strings="undefined") 
```

## 3. Initial setup
```{r}
national$dt<-as.Date(ymd_hms(national$data))
national$data<-NULL 
national$stato<-NULL
col_names<-colnames(national)

intl_col_names<-gsub("ricoverati_con_sintomi","hospitalized_with_symptoms",col_names)
intl_col_names<-gsub("terapia_intensiva","intensive_care",intl_col_names)
intl_col_names<-gsub("totale_ospedalizzati","hospitalized_total",intl_col_names)
intl_col_names<-gsub("isolamento_domiciliare","home_isolation",intl_col_names)
intl_col_names<-gsub("variazione_totale_positivi","num_positives_variation",intl_col_names)
intl_col_names<-gsub("totale_positivi","positives_remaining",intl_col_names)
intl_col_names<-gsub("nuovi_positivi","positives_added_on_dt",intl_col_names)
intl_col_names<-gsub("dimessi_guariti","total_discharged_healed",intl_col_names)
intl_col_names<-gsub("deceduti","total_deceased",intl_col_names)
intl_col_names<-gsub("totale_casi","total_cases",intl_col_names)
intl_col_names<-gsub("tamponi","tests",intl_col_names)
intl_col_names<-gsub("note_","notes_",intl_col_names)
colnames(national)<-intl_col_names
national<-arrange(national, dt)
```


```{r}
nat<-national[-1,]
nat$dt_previous<-ymd(nat$dt)-1
nat2<-national[-(nrow(national)),]
nat2$notes_it<-NULL 
nat2$notes_en<-NULL 
col_names_previous_dt<-paste(colnames(nat2),'previous',sep="_")
colnames(nat2)<-col_names_previous_dt
nat3<-full_join(nat, nat2, by='dt_previous')
nat3<-arrange(nat3, dt)
nat3$tests_delta<-nat3$tests-nat3$tests_previous
nat3$home_isolation_delta<-nat3$home_isolation-nat3$home_isolation_previous
nat3$hospitalized_with_symptoms_delta<-nat3$hospitalized_with_symptoms-nat3$hospitalized_with_symptoms_previous
nat3$intensive_care_delta<-nat3$intensive_care-nat3$intensive_care_previous
nat3$discharged_healed_delta<-nat3$total_discharged_healed-nat3$total_discharged_healed_previous
nat3$deceased_delta<-nat3$total_deceased-nat3$total_deceased_previous
nat3$positives_remaining_delta<-nat3$positives_remaining-nat3$positives_remaining_previous
identical(nat3$positives_remaining_delta, nat3$num_positives_variation)
```
```{r}
nat3$total_tests_cases_ratio_prev<-nat3$tests_prev/nat3$total_cases_previous
nat3$tests_per_positive_on_dt_ratio<-nat3$tests_delta/nat3$positives_added_on_dt
nat3$positives_remaining_percent_delta<-nat3$positives_remaining_delta/nat3$positives_remaining_previous*100
nat3$deceased_per_positives_day_before_ratio<-nat3$deceased_delta/nat3$positives_remaining_previous
nat3$discharged_healed_per_positives_day_before_ratio<-nat3$discharged_healed_delta/nat3$positives_remaining_previous
```


```{r}
plot(nat3$dt,nat3$positives_remaining_delta,type='b', main="Positives remaining (daily variation)",xlab='',ylab="People", col="orange")
```

```{r}
nat4<-select(nat3, dt, deceased_per_positives_day_before_ratio, discharged_healed_per_positives_day_before_ratio)
nat4$discharged_or_healed_to_deceased_ratio<-nat4$discharged_healed_per_positives_day_before_ratio/nat4$deceased_per_positives_day_before_ratio
```

```{r}
plot(nat4$dt, nat4$deceased_per_positives_day_before_ratio*100, type='l', main='Fatalities per active cases on the previous day',xlab=paste(format(min(nat$dt),"%d %b"),"-",format(max(nat$dt),"%d %b")),ylab="%",col="red")
```

```{r}
plot(nat4$dt, nat4$discharged_healed_per_positives_day_before_ratio*100, type='l', main='Discharged or healed per positive cases on the previous day',xlab=paste(format(min(nat$dt),"%d %b"),"-",format(max(nat$dt),"%d %b")),ylab="%",col="darkgreen")
```
```{r}
plot(nat4$dt, nat4$discharged_or_healed_to_deceased_ratio, type='l', main='Daily proportion: discharged or healed compared to deceased',sub="Given the remaining positive cases on the day before",xlab=paste(format(min(nat$dt),"%d %b"),"-",format(max(nat$dt),"%d %b")),ylab="Higher numbers are better (1 = equal, 2 = twice, etc)",col="orange")
```

```{r}
print(select(nat4, dt, discharged_or_healed_to_deceased_ratio))
summary(nat4$discharged_or_healed_to_deceased_ratio)
```
